{% extends 'layout.html' %}
{% import 'macros.html' as m %}
{% block bodyID %}page-tutorial{% endblock %}
{% block header %}
{% endblock %}
{% block body %}
<main class="container">
<div class="row">
    <div class="col-xs-12 col-md-7">
        <section class="tutorial">
            <h1 class="page-header">{{ article.title }}</h1>
            <div class="tutorial-body">
                {{ article.body }}
            </div>
            <footer class="tutorial-footer">
                By <a href="#" class="author">{{ article.author.username }}</a><br/>
                <span class="date-created">{{ article.date_created|fromnow }}</span><br/>
{#                <span class="last-modified">Last modified 3 days ago</span>#}
            </footer>
        </section>
        <div class="comment-container">
            <div class="comment-header row row-table-xs">
                <div class="col-xs-8">
                    <h1>Comments</h1>
                </div>
                <div class="col-xs-4">
                    <a  data-toggle="collapse"
                        href="#comment-article-form"
                        aria-expanded="false"
                        id="btn-add-comment"
                        onclick="$(this).fadeOut();"
                        class="btn btn-primary pull-right">Add Comment</a>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12">
                <div id="comment-article-form" class="add-comment media collapse">
                        <a class="media-left" href="#">
                             <img class="avatar" src="">
                        </a>
                        <div class="media-body">
                            {{ forms['commentForm'].hidden_tag() }}
                            {% for field in forms['commentForm'] if field.widget.input_type != 'hidden' %}
                                {% if field.type == 'TextAreaField' %}
                                    {{ m.render_input_group(field, cols=30, rows=4, placeholder=field.label.text) }}
                                {% else %}
                                    {{ m.render_input_group(field, placeholder=field.label.text) }}
                                {% endif %}
                            {% endfor %}
                            <div class="actionbar text-right">
                                <a
                                 data-toggle="collapse"
                                 href="#comment-article-form"
                                 aria-expanded="false"
                                 onclick="$('#btn-add-comment').fadeIn()"
                                 class="btn btn-danger">Cancel</a>
                                <a href="#" class="btn btn-primary">Submit</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12">
                {# Display comments  #}
                <ul class="media-list">
                    {% for comment, depth, children in comments recursive -%}
                        {% if depth == 0 %} {# start a new head comment #}
                            <li class="media" id="comment-{{ comment.id }}">
                        {% else %}
                            {# lets ignore any depths higher than 1... #}
                            <div class="reply media depth-1" id="comment-{{ comment.id }}">
                        {% endif %}
                        <a class="media-left" href="#">
                            <img class="avatar" src="{{ url_for('static', filename='uploads/avatars/' + comment.user.avatar) }}">
                        </a>
                        <div class="media-body">
                            <h4 class="media-heading">{{ comment.subject }}</h4>
                            <div class="comment-info"><a class="reply-to" href="#">@{{ comment.user.username }}</a>

                            {% set lastmodified = comment.last_modified|default(comment.date_created, true) %}
                            <span data-lastmodified="{{ lastmodified }}" class="comment-date">{{lastmodified|fromnow}}</span></div>
                            <div class="content">
                            {{ comment.message }}
                            </div>
                            <div class="actionbar text-right">
                                <a href="#" class="btn btn-reply btn-primary">Reply</a>
                                <a href="#" style="display: none" data-id="{{ comment.id }}" class="btn btn-submit btn-primary">Submit</a>
                            </div>
                        </div>
                        {% if depth == 0 %} {# if is a parent container #}
                            {% if children %}
                                {{ loop(children) }} {# recusively add its children #}
                            {% endif %}
                             </li> {# close the parent container #}
                        {% else %}
                             </div> {# close a child container #}
                        {% endif %}
                    {%- endfor %}
                </ul>
                </div>
            </div>
        </div>
    </div>
        <section class="right-panel col-md-4 col-md-offset-1">
            {% if current_user.is_authenticated() -%}
            <div class="is-logged-in">
                <div class="profile">
                    <div class="avatar"></div>
                    <div class="more-info">
                        <div class="profile-name">{{ current_user.full_name }}</div>
                        <div class="settings"><a href="#">Settings</a></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div id="login-form" class="animated fadeIn nav-tabs-container">
                <!-- TAB NAVIGATION -->
                <ul id="form-tabs" class="nav nav-tabs nav-justified no-collapse" role="tablist">
                    <li class="active"><a href="#tab-register" role="tab" data-toggle="tab">Register</a></li>
                    <li><a href="#tab-login" role="tab" data-toggle="tab">Login</a></li>
                </ul>
                <!-- TAB CONTENT -->
                <div class="tab-content">
                    <div class="active tab-pane fade in" id="tab-register">
                        <form action="{{ url_for('frontend.register') }}" method="post" role="form">
                            {{ forms['register'].csrf_token }}
                            {% for field in forms['register'] if field.widget.input_type != 'hidden' -%}
                                    {{ m.render_field(field, label_class='sr-only', placeholder=field.label.text) }}
                            {% endfor %}
                            <button type="submit" class="btn btn-block btn-lg btn-danger">Get Started</button>
                        </form>
                        <div class="social-media">
                            <p class="info">Or register with:</p>
                            <p class="text-justify-full">
                                {{ m.get_social_buttons([
                                {'google-plus':'#'},
                                {'github':url_for('oauth.github_authorized')},
                                {'facebook':url_for('oauth.facebook_authorized')}]) }}
                            </p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-login">
                        <form action="{{ url_for('frontend.login') }}" method="post" role="form">
                            {{ forms['login'].csrf_token }}
                            {% for field in forms['login'] if field.widget.input_type != 'hidden' -%}
                                    {{ m.render_field(field, label_class='sr-only', placeholder=field.label.text) }}
                            {% endfor %}
                            <button type="submit" class="btn btn-block btn-lg btn-danger">Login</button>
                        </form>
                        <div class="social-media">
                            <p class="info">Or login with:</p>
                            <p class="text-justify-full">
                                {{ m.get_social_buttons([
                                {'google-plus':'#'},
                                {'github':url_for('oauth.github_authorized')},
                                {'facebook':url_for('oauth.facebook_authorized')}]) }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </section>
    </div>
</main>
{% endblock %}

{% block bodyPostfix %}
<script id="comment-template" type="text/html">
<li class="media" id="comment-">
    <a class="media-left" href="#"><img class="avatar" src=""></a>
    <div class="media-body">
        <h4 class="media-heading"></h4>
        <div class="comment-info">
            <a class="reply-to" href="#">@larantessa@gmail.com</a>
            <span data-lastmodified="" class="comment-date"></span>
        </div>
        <div class="content"></div>
        <div class="actionbar text-right">
            <a href="#" data-id="" class="btn btn-reply btn-primary">Reply</a>
            <a href="#" style="display: none" data-id="" class="btn btn-submit btn-primary">Submit</a>
        </div>
    </div>
</li>
</script>

<script id="comment-form" type="text/html">
    <form class="comment-form collapse" aria-expanded="false" action="">
    {{ forms['commentForm'].hidden_tag() }}
    {% for field in forms['commentForm'] if field.widget.input_type != 'hidden' %}
        {% if field.type == 'TextAreaField' %}
            {{ m.render_input_group(field, cols=30, rows=4, placeholder=field.label.text) }}
        {% else %}
            {{ m.render_input_group(field, placeholder=field.label.text) }}
        {% endif %}
    {% endfor %}
    </form>
</script>

<script>
$(function($) {

    var $commentContainer,
        $commentArticleForm;

    function getLastModified() {
        var $e = $('.media-list').find('[data-lastmodified]'),
            timestamps;

        if ($e.length == 0) return null;

        timestamps = $e.map(function(i, e) {return $(e).data('lastmodified');}).get();

        var i, length, max;
        length = timestamps.length;
        max = timestamps[0];
        // since the `lastmodified` timestamps are formatted "YYYY-MM-DD hh-mm-ss"
        // there's no need to convert it to a datetime object
        for (i = 1; i < length; i++)
            if (timestamps[i] > max)
                max = timestamps[i];

        return max;
    }

    function submitComment($form, callback) {
        $.ajax({
            url: '{{ url_for('frontend.add_comment') }}',
            beforeSend: app.getCSRFHeader(),
            type: 'POST',
            dataType: 'json',
            data: $form.find('input, textarea').serialize() + '&'+$.param({lastmodified:getLastModified()}),
            success: callback.success,
            error: callback.error
        });
    }

    function updateComments(comments) {
        var $parentTemplate = $($('#comment-template').html()).filter('li'),
            $childTemplate = $('<div></div>', {'class': 'reply media depth-1'})
                                .append($parentTemplate.html());

        comments.forEach(function(item, i) {
            var $e,
                $container,
                isParent = item.parent_id == null;

            $e = isParent ? $parentTemplate.clone() : $childTemplate.clone();

            $e.data('item', item);
            $e.attr('id', 'comment-'+item.id);
            $e.find('.media-heading').html(item.subject);
            $e.find('.content').html(item.message);
            $e.find('.reply-to');
            $e.find('.comment-date')
                .attr('data-lastmodified', item.last_modified ? item.last_modified : item.date_created);
            $e.find('.btn-submit').attr('data-id', item.id);
            if (isParent) {
                // start a new comment list
                $('.media-list').append($e);
            } else {
                // append it below the parent id
                $container = $('#comment-' + item.parent_id);
                if ($container.is('li')) {
                    $container.append($e);
                } else {
                    $container.parent().append($e);
                }
            }
        });
    }

    $commentArticleForm = $('#comment-article-form');
    $commentArticleForm.find('.btn-primary').on('click',function(e) {
        submitComment($commentArticleForm, {
            success: function(data) {
                updateComments(data.comments);
                $commentArticleForm
                    .find('.form-group')
                    .find('input, textarea').val('');
                $commentArticleForm.collapse('hide');
            },
            error: function(data) {
                app.displayMessages($commentArticleForm, data.responseJSON['flashed_messages'])
            }
        });
        $('#btn-add-comment').show();
        $commentArticleForm.collapse('show');
        e.preventDefault();
    });

    $commentContainer = $('.media-list');
    $commentContainer.on('click', '.btn-reply', function(e) {
        var $btnReply = $(this),
            $form = $btnReply.closest('.media-body').find('form');

        if ($form.length == 0) {
            // create a form using the provided template
            $form = $($('#comment-form').html()).clone();
            // insert the form after `.content`
            $btnReply.closest('.media-body')
                .find('.content').after($form);
        }

        $form.collapse('toggle');
        e.preventDefault()
    });

    $commentContainer.on('shown.bs.collapse', 'form', function(e) {
        // update this form's parent_id input field
        var $form = $(this),
            $btnSubmit = $form.closest('.media-body').find('.btn-submit'),
            $btnReply = $btnSubmit.prev();
        $form.find('#parent_id').val($btnSubmit.data('id'));
        // position the submit button
        $btnSubmit.show();
        // toggle button states
        $btnReply.html('Cancel');
        $btnReply.toggleClass('btn-primary btn-danger');
    });

    $commentContainer.on('hide.bs.collapse', 'form',function(e) {
        // update this form's parent_id input field
        var $btnSubmit = $(this).closest('.media-body').find('.btn-submit'),
            $btnReply = $btnSubmit.prev();
        // update this form's parent_id input field
        $btnSubmit.hide();
        // toggle button states
        $btnReply.html('Reply');
        $btnReply.toggleClass('btn-primary btn-danger');
    });


    $commentContainer.on('click', '.btn-submit', function(e) {
        var $form = $(this).closest('.media-body').find('form');
        submitComment($form, {
            success: function(data) {
                $form.find('input, textarea').val('');
                $form.collapse('toggle');
                updateComments(data.comments);
            },
            error: function(data) {
            }
        });
        e.preventDefault();
    });

}, jQuery)
</script>

<script>
    $(function () {
        var $loginForm = $('#login-form'),
            $footer = $('.footer-sticky'),
            legacyIE = bowser.msie && bowser.version <= 9;

        if ( ! $loginForm.length || ! $footer.length) return;

        $(document).scroll(function () {
            if ($loginForm.isAbove($footer[0])) {
                if ($loginForm.hasClass('fadeIn')) {
                    // Make form disappear
                    $loginForm.toggleClass('fadeIn fadeOut');
                    if (legacyIE) {
                        $loginForm.animate({opacity: 0}, 400, 'swing', function () {$loginForm.invisible();});
                    }
                }
            } else if ($loginForm.hasClass('fadeOut')) {
                // Make login form visible
                $loginForm.toggleClass('fadeIn fadeOut');
                if (legacyIE) {
                    $loginForm.visible().animate({opacity: 1.0}, 400);
                }
            }
        });
    });
</script>

{% endblock %}