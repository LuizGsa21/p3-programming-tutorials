{%- import 'macros.html' as m -%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500' rel='stylesheet' type='text/css'>
    <!--Logo font-family-->
    <link href='http://fonts.googleapis.com/css?family=Cinzel' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js DOESN't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    {# temp favicon #}
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    {%- block metaTags %}{% endblock -%}
    {%- block header %}{% endblock %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
</head>
<body id="{% block bodyID %}{% endblock %}">
{% set active_page = active_page|default('Home') -%}
{% set hidden_links = hidden_links|default(['Login', 'Register'] if isLoggedIn else ['Profile', 'Logout']) -%}

{# Main navbar #}
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Programming Tutorials</a>
        </div>
        <div class="collapse navbar-collapse navbar-main-collapse">
            <ul id="navbar-inner" class="nav navbar-nav navbar-right">
                {# Home page #}
                <li><a href="{{ url_for('frontend.index') }}">Home</a></li>
                {# Dropdown containing all categories page #}
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                         {% for category in categories -%}
                             <li><a href="{{ url_for('frontend.category_articles', category=category.name) }}">{{ category.name }}</a></li>
                        {% endfor -%}
                        </ul>
                    </li>
                    <li><a href="{{ url_for('user.profile') }}">Profile</a></li>
                    <li><a class="nav-logout" href="{{ url_for('frontend.logout') }}">Logout</a></li>
                    <li><a class="nav-login" href="#tab-login">Login</a></li>
                    <li><a class="nav-register" href="#tab-register">Register</a></li>
            </ul>
            <script>
            +function() {
                var links = document.querySelectorAll('#navbar-inner a'),
                    length = links.length,
                    hidden = {{ hidden_links|safe }},
                    hiddenLength = hidden.length,
                    activePage = '{{ active_page }}';
                for (var i = 0; i < length; i++) {
                    var text = links[i].innerHTML;
                    if (text == activePage) {
                        links[i].parentNode.className = 'active';
                    }
                    var updated = false;
                    for (var j = 0; j < hiddenLength; j++) {
                        if (text == hidden[j]) {
                            links[i].style.display = 'none';
                            updated = true;
                            break;
                        }
                    }
                    if (!updated) links[i].style.display = 'block';
                }
            }();
            </script>
        </div><!-- /.navbar-collapse -->
    </div>
</nav>

{%- block body %}{% endblock -%}

{# Footer #}
<footer class="footer footer-default footer-sticky animated fadeIn">
        <div class="container">
            <div class="row">
                <div class="col-xs-12 col-sm-4 col-md-4">
                    <h4 class="title">Navigation</h4>
                    {% for chunk in categories|chunks(5) %}
                        <ul class="nav footer-nav pull-left">
                            {% for category in chunk %}
                                <li><a href="{{ url_for('frontend.category_articles', category=category) }}">{{ category }}</a></li>
                            {% endfor %}
                        </ul>
                    {% endfor %}
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4 valign">
                    <div class="quote">"Programming is a lifestyle."</div>
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4 col-lg-3 col-lg-offset-1">
                    <div class="stay-connected">
                        <h4 class="title">Stay Connected</h4>
                        <p class="text-justify-full">
                            {{ m.get_social_buttons([
                                {'google-plus':'https://plus.google.com/103499838655205368925/posts'},
                                {'twitter':'https://twitter.com/LArantesSa'},
                                {'github':'https://github.com/LuizGsa21'}]) }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="copyright text-center">Copyright &copy; All Rights Reserved</div>
                </div>
            </div>
        </div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="{{ url_for('static', filename='js/bowser.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-plugins.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.form.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<!--[if lte IE 9 ]>
<script src="{{ url_for('static', filename='js/jquery.html5-placeholder-shim.js') }}"></script>
<![endif]-->

<div id="fb-root"></div>

<script>
    "use strict";
    // Initialize app variables
    app.isLoggedIn = {{ isLoggedIn|lower }};
    app.csrfToken = '{{ csrf_token()|safe }}'; // used for ajax requests

    app.logout = function(onSuccess, onFail) {
        $.ajax({
            url: '{{ url_for('frontend.logout') }}',
            type: 'POST',
            beforeSend: app.getCSRFHeader(), // csrf protection
            success: function(data) {
              app.isLoggedIn = false;
              onSuccess(data)
            },
            error: onFail
        });
    };
    // Setup google oauth
    app.google = {
        init: function() {
            // Retrieve the singleton from the GoogleAuth library
            gapi.load('auth2', function() {
                this.auth2 = gapi.auth2.init({
                    // client_id <- notice the underscore. This is for Google Sign-In depend
                    client_id: '{{ 'GOOGLE_CLIENT_ID'|os_environ|safe }}',
                    cookiepolicy: 'single_host_origin',
                    fetch_basic_profile: false,
                    scope: 'openid email'
                });
            }.bind(this));
        },
        requestOfflineAccess: function(onSuccess, onFail) {
            console.log(this.auth2);
            this.auth2
                .grantOfflineAccess({'redirect_uri': 'postmessage'})
                .then(function(authResult) {
                    console.log('here');
                      if (authResult['code']) {
                          $.ajax({
                            type: 'POST',
                            url: '{{ url_for('oauth.google_authorized') }}' ,
                            data: authResult['code'],
                            contentType: 'application/octet-stream; charset=utf-8',
                            processData: false,
                            beforeSend: app.getCSRFHeader(), // csrf protection
                            success: function(data) {
                              app.isLoggedIn = true; // update login status
                              onSuccess(data);
                            },
                            error: onFail
                          });
                      } else {
                          onFail(authResult);
                      }
                });
        }
    };

    app.facebook = {
        load: function() {
            window.fbAsyncInit = function() {
              FB.init({
                appId      : '{{ 'FACEBOOK_CLIENT_ID'|os_environ|safe }}',
                xfbml      : true,
                version    : 'v2.3'
              });
            };

            (function(d, s, id){
               var js, fjs = d.getElementsByTagName(s)[0];
               if (d.getElementById(id)) {return;}
               js = d.createElement(s); js.id = id;
               js.src = "//connect.facebook.net/en_US/sdk.js";
               fjs.parentNode.insertBefore(js, fjs);
             }(document, 'script', 'facebook-jssdk'));
        },
        login: function(onSuccess, onFail) {
            FB.login(function(response) {
                if (response.authResponse) {
                  var accessToken = FB.getAuthResponse()['accessToken'];
                  FB.api('/me', function(response) {
                    $.ajax({
                        url: '{{ url_for('oauth.facebook_authorized') }}',
                        type: 'POST',
                        beforeSend: app.getCSRFHeader(), // csrf protection,
                        processData: false,
                        contentType: 'application/octet-stream; charset=utf-8',
                        data: accessToken,
                        success: function(data) {
                           app.isLoggedIn = true; // update login status
                           onSuccess(data)
                        },
                        error: onFail
                    });
                  });
                } else {
                  onFail(response);
                }
            }, {scope: 'public_profile,email'});
        }
    };


    app.github = {
        login: function(onSuccess, onFail) {
            // github doesn't have a javascript api like google and facebook,
            // so we will make our own popup
            var popupWindow   = window.open('', 'githubLogin', 'location=0,status=0,width=800,height=400');

            var form = this.createForm();
            $('body', popupWindow.document).append(form);
            $(form, popupWindow.document).submit();

            // keeping checking if the popup is open every .5 seconds
            var popupInterval = setInterval(function(){

                if (popupWindow.closed) {
                    clearInterval(popupInterval); // clear this interval

                    // when the popup window closes get the response object from `window.popupResult`
                    if (window.popupResult) {
                        // save result then set `popupResult` back to undefined
                        var data = window.popupResult;
                        window.popupResult = undefined;

                        // call the appropriate callback
                        if (data['success']) {
                            app.isLoggedIn = true; // update login status
                            onSuccess(data);
                        } else {
                            onFail(data)
                        }

                    } else {
                        // code reaches here when the user manually closes the popup window
                        onFail();
                    }
                }
            }, 500);
        },
        createForm: function() {
            return [
                '<form id="myForm" method="post" action="{{ url_for("oauth.github_login", _external=True) }}">',
                    '<input type="hidden" name="csrf_token" value="', app.csrfToken, '"/>',
                '</form>'
            ].join('')
        }
    };

    // Load facebook SDK
    app.facebook.load();
    // initialize google plus callback
    function googleInit() {
        console.log('google loaded');
        app.google.init();
    }

    // Let the users know we don't care about IE8
    if (bowser.msie && bowser.version <= 8) {
        alert('It seems like you are using Internet Explorer '
            + bowser.version + '. If you care about the internet please update your web browser.');
    }
</script>
<script src="https://apis.google.com/js/api:client.js?onload=googleInit"></script>
{% block bodyPostfix %}{% endblock %}
</body>
</html>