{% extends 'layout.html' %}
{% from 'macros.html' import render_field, alert_messages %}

{% block bodyID %}page-profile{% endblock %}
{% block body %}
<section class="profile">
    <div class="container">
        <div class="row"><div class="col-xs-12 alert-box"></div></div>
        <div class="row row-table-md">
            <div class="col-xs-12 col-md-4">
                <div class="avatar"></div>
                <div class="more-info">
                    <div class="profile-name"></div>
                    <div class="settings"><a data-toggle="modal" data-action="changeAvatar" data-target="#main-modal" href="#">change avatar</a></div>
                </div>
            </div>
            <div class="col-xs-12 col-md-8 general-info-container">
                {{ alert_messages(get_flashed_messages(with_categories=true)) }}
                <table id="profile-table" class="table table-hover profile-table">
                    <thead><tr>
                            <th class="title">General Info</th>
                            <th class="text-right"><a href="#" class="btn btn-profile-edit btn-xs btn-warning" data-toggle="modal" data-action="editProfile" data-target="#main-modal">Edit</a>
                            </th>
                    </tr></thead>
                    <tbody>
                        <tr><th>Username</th>
                            <td class="username"></td></tr>

                        <tr><th>Email</th>
                        <td class="email"></td></tr>

                        <tr><th>First Name</th>
                            <td class="first_name"></td></tr>

                        <tr><th>Last Name</th>
                            <td class="last_name"></td></tr>

                        <tr><th>Date Joined</th>
                            <td class="date_joined"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</section>

<section class="published-tutorials">
    <div class="container">
        <div class="row row-table-sm">
            <div class="col-xs-12 col-sm-8">
                <h1 class="main-title">Published Tutorials</h1>
            </div>
            <div class="col-xs-12 col-sm-4 add-btn-container">
                <a href="#" id="btn-add-new" data-toggle="modal" data-action="addTutorial" data-target="#main-modal" class="btn btn-primary">
                    Add New <span class="glyphicon glyphicon-plus-sign"></span></a>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 table-container">
                <table id="tutorial-table" class="table table-hover published-tutorials-table">
                    <thead><tr><th>Title</th><th>Category</th><th>Date Created</th><th>Action</th></tr></thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<div id="main-modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-cancel" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-submit">Submit</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
{% endblock %}

{% block bodyPostfix %}
<!-- Templates
========================================================  -->
<script id="templates" type="text/html">
{#    <input id="id" name="id" type="hidden" value="">#}
    <div class="alert-messages">
            <div class="alert">
                <a href="#" class="close" data-dismiss="alert">&times;</a>
            </div>
    </div>

    <table><thead></thead>
    <tbody>
        <tr>
            <td class="title"></td>
            <td class="category"></td>
            <td class="date"></td>
            <td class="action">
                <a href="#" class="btn btn-sm btn-warning" data-toggle="modal" data-action="editTutorial" data-target="#main-modal">Edit</a>
                <a href="#" class="btn btn-sm btn-danger" data-toggle="modal" data-action="deleteTutorial" data-target="#main-modal">Delete</a>
            </td>
        </tr>
    </tbody>
    </table>

    <form id="form-tutorial" method="post">
        {% for field in forms.addArticle if field.widget.input_type != 'hidden' -%}
            {%- if field.name == 'body' %}
                {{ render_field(field, cols=30, rows=4) }}
            {% else %}
                {{ render_field(field) }}
            {% endif %}
        {% endfor %}
    </form>
    <form id="form-profile" action="{{ url_for('user.edit_profile') }}" method="post">
        {{ forms.editProfile.hidden_tag() }}
        {% for field in forms.editProfile if field.widget.input_type != 'hidden' %}
            {{ render_field(field) }}
        {% endfor %}
    </form>
    <form id="form-avatar-upload" action="{{ url_for('user.upload') }}" method="post" enctype="multipart/form-data">
        {% for field in forms.uploadAvatarForm if field.widget.input_type != 'hidden' %}
            {{ render_field(field) }}
        {% endfor %}
    </form>
</script>
<!-- END templates ========================================================  -->

<script>
    +function ($) {
        // attach csrf_token on ajax calls
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}")
                }
            }
        });

        function initTemplates() {
            var temp = $($('#templates').html());
            // create a clone wrapper to ensure the templates return a new instance
            var clone = function() {return this.clone()};
            return {
                tutorialForm: clone.bind(temp.filter('#form-tutorial')),
                profileForm: clone.bind(temp.filter('#form-profile')),
                tutorialRow: clone.bind(temp.find('tr')),
                avatarUploadForm: clone.bind(temp.filter('#form-avatar-upload')),
                alert: clone.bind(temp.filter('.alert-messages'))
            };
        }

        // inner-global variables
        var tutorials = {{ current_user.articles|custom_json(serializers['article'])|safe }},
            userInfo = {{ current_user|custom_json(serializers['userInfo'])|safe }},
            $mainModal = $('#main-modal'),
            templates = initTemplates();

        // Creates and returns an alert dialog.
        function createAlert(message, category) {
            var $template = templates.alert();
                $template.addClass(['alert-', category].join(''));
                $template.find('.alert').append(message);
                return $template;
        }

        /**
         * @param $form
         * @param formErrors - [ {formLabelID: arrayOfErrorMessages}, ... ]
         */
        function setFormErrors($form, formErrors) {
            // clear any previous errors before setting the form
            $form.find('.form-group').removeClass('has-error');
            $form.find('.help-block').remove();

            for (var labelID in formErrors) {
               formErrors[labelID].forEach(function(errorMessage) {
                 this.parent().addClass('has-error');
                 this.after($('<p></p>').addClass('help-block').html(errorMessage));

               }.bind($form.find(['#', labelID].join(''))));
            }
        }


        // Displays flashedMessages. Creates form errors or alert messages
        // depending on the message's category
        function displayMessages($element, action, flashedMessages) {
            // ensure a jQuery element was given
            if (! ($element instanceof jQuery) ) $element = $($element);

            flashedMessages.forEach(function(message) {
                if (message.category == 'form-error') {
                   // populate the form with the given errors
                   setFormErrors($element, message.message);
                } else {
                    $element[action](createAlert(message.message, message.category));
                }
            });
        }

        function tutorialAddRows(rows, action) {
                var $template,
                    item,
                    templateBuffer = [],
                    $table = $('#tutorial-table'),
                    // if a single row was given turn it to an array
                    dataArray = (rows instanceof Array) ? rows : [rows],
                    createTemplate = templates.tutorialRow,
                    length = dataArray.length;

                $('.empty-table').remove(); // remove empty table cell

                for (var i = 0; i < length; i++) {
                    item = dataArray[i];
                    $template = createTemplate();
                    $template.attr('id', ['tutorial-', item.id].join(''));
                    $template.find('.title').html(item.title);
                    $template.find('.category').html(item.category.name);
                    $template.find('.date').html(item.date_created);
                    $template.find('.action a').data('item', item);
                    templateBuffer.push($template)
                }
                // add rows to DOM
                $table.find('tbody').append(templateBuffer);
        }

        function tutorialDeleteRows(rows) {
            var $table, $tableBody, item;
            $table = $('#tutorial-table');
            $tableBody = $table.find('tbody');
            // if a single row was given turn it to an array
            rows = (rows instanceof Array) ? rows : [rows];

            for (var i = 0; i < rows.length; i++) {
                item = rows[i];
                $('#tutorial-'+item.id).remove();
            }

            if ($tableBody.find('tr').length == 0) {
                addEmptyRow('#tutorial-table', 'No published tutorials', 4)
            }
        }


        function addEmptyRow(selector, messsage, colspan) {
            // add an informative row to display to the user
            $(selector)
                .find('tbody')
                .html(['<tr class="empty-table"><td colspan="',
                        colspan,'" class="text-center">', messsage,'</td></tr>'].join(''));
        }


        function updateProfile(data) {
            var $table, $avatar;
            $table = $('#profile-table');
            $avatar = $('.avatar');
            for (var key in data) {
                if (key == 'avatar') {
                    $avatar.css({backgroundImage: 'url('+data[key]+')'});
                } else {
                    $table.find('.'+key).html(data[key] || 'Not available');
                }
            }
            $table.find('.btn-profile-edit').data('item', data);
            $('.profile-name').html(data['username']);
        }

        // Initialize modalBuilder
        // These methods will be triggered by the `show.bs.modal` event
        // depending on the current action
        var modalBuilder = {
            addTutorial: function ($modal) {
                var $form = templates.tutorialForm();
                // set form url
                $form.attr('action', '{{ url_for('user.add_article') }}');

                // Update modal title
                $modal.find('.modal-title').append('Add Tutorial');
                $modal.find('.modal-body').append($form);

                // update action button css
                var $actionBtn = $modal.find('.btn-submit');
                $actionBtn.addClass('btn-primary').html('Add Tutorial');
            },
            editTutorial: function ($modal) {
                var $form = templates.tutorialForm(),
                    item = $modal.data('item');
                // set form url
                $form.attr('action', '{{ url_for('user.edit_article') }}');

                // Update modal title
                $modal.find('.modal-title').append('Edit Tutorial');

                // populate form fields
                $.each(item, function(key, value) {
                    // category returns and object {id:value, name:value}
                    if (key == 'category') {
                        value = value.id;
                    }
                    $form.find(['#', key].join('')).val(value);
                });

                // add input field with the item's id attached
{#                $form.prepend($('<input/>').attr({type:'hidden', name:'id', value: item.id}));#}
                $form.append('<input id="id" name="id" type="hidden" value="'+item.id+'"/>');

                // append hidden form to body
                $modal.find('.modal-body').append($form);

                // update action button css
                var $actionBtn = $modal.find('.btn-submit');
                $actionBtn.addClass('btn-primary').html('Save Tutorial');
            },
            deleteTutorial: function($modal) {
                var item = $modal.data('item'),
                    title = item.title,
                    $form = $('<form/>', {
                        action: '{{ url_for('user.delete_article') }}',
                        method: 'POST'
                    });
                $form.append('<input id="id" name="id" type="hidden" value="'+item.id+'"/>');

                // create title
                $modal.find('.modal-title')
                    .append('<span class="text-danger">Warning!!!</span>');

                var $modalBody = $modal.find('.modal-body');
                // append hidden form and the dialog message to the modal's body
                $modalBody.append($form)
                          .append(['<p>Are you sure you want to delete <strong class="text-danger">', title,
                                  '</strong> permanently?</p>'].join(''));
                // update action button css
                var $actionBtn = $modal.find('.btn-submit');
                $actionBtn.addClass('btn-danger').html('Delete Tutorial');
            },
            editProfile: function($modal) {
                var item, title, $form;
                item = $modal.data('item');
                $form = templates.profileForm();
                $form.find(':input').each(function() {
                    if (this.type == 'hidden') return; // ignore hidden fields
                    $(this).val(item[this.id]);
                });
                $modal.find('.modal-title').html('General Info');
                $modal.find('.modal-body').append($form);
                $modal.find('.btn-submit').addClass('btn-primary').html('Save Profile')
            },
            changeAvatar: function($modal) {
                var item, title, $form;
                item = $modal.data('item');
                $form = templates.avatarUploadForm();
                $modal.find('.modal-title').html('Avatar');
                $modal.find('.modal-body').append($form);
                $modal.find('.btn-submit').addClass('btn-primary').html('Upload Avatar')
            }
        };

        //---- Modal setup
        // ensure old content gets deleted after modal closes
        $mainModal.on('hidden.bs.modal', function () {
            ['.modal-title', '.modal-body'].forEach(function (selector) {
                $($mainModal).find(selector).html('');
            });
            // remove action button css
            $mainModal.find('.btn-submit').removeClass('btn-primary btn-danger btn-warning');
            $mainModal.removeData();
        });

        // Dynamically create the modal's content before its shown
        $mainModal.on('show.bs.modal', function (e) {
            var data = $(e.relatedTarget).data();
            $mainModal.data(data);
            modalBuilder[data.action]($mainModal);
        });

        // AJAX action handlers
        var responseHandler = {
            addTutorial: function ($modal, data) {
                var messages = data['flashed_messages'];
                    tutorialAddRows(data.article);
                    displayMessages('#tutorial-table', 'before', messages);
            },
            editTutorial: function($modal, data) {
                var messages, item, $row;
                messages = data['flashed_messages'];
                item = data.article;
                // get item row and update its content
                $row = $('#tutorial-' + item.id);
                $row.find('.category').html(item.category.name);
                $row.find('.title').html(item.title);
                $row.find('a').data('item', item);
                displayMessages('#tutorial-table', 'before', messages);
            },
            deleteTutorial: function($modal, data) {
                var item;
                item = $modal.data('item');
                tutorialDeleteRows(item);
                $modal.modal('hide');
                displayMessages('#tutorial-table', 'before', data['flashed_messages']);
            },
            editProfile: function($modal, data) {
                var item, messages;
                messages = data['flashed_messages'];
                item = data.userInfo;
                updateProfile(item);
                displayMessages($('#profile-table'), 'before', messages);

            },
            changeAvatar: function($modal, data) {
                // don't ask LOL.
                this.editProfile($modal, data);
            }
        };
        // send AJAX request when user clicks the modal's action button
        $mainModal.find('.btn-submit')
        .on('click', function(e) {
            var currentAction, $form;
            // get the current action:
            //      [add|edit|delete]Article]
            //      editProfile
            //      changeAvatar
            currentAction = $mainModal.data('action');

            // extract the form from modal and submit ajax request
            $form = $mainModal.find('form');
            $form.ajaxSubmit({
                dataType: 'json',
                success: function(data) {
                    $('.alert-messages').remove(); // remove any previous alerts
                    responseHandler[currentAction]($mainModal, data);
                    $mainModal.modal('hide');
                },
                error: function(data) {
                    $('.alert-messages').remove();

                    // If the server returned a JSON on error.
                    // display the errors inside the modal
                    if (data.responseJSON) {
                        displayMessages($mainModal.find('form'), 'before', data.responseJSON['flashed_messages']);
                    } else {
                        // else dynamically create an alert message and append to '.alert-box'
                        var message;
                        if (data.status == 400) {
                            // extract error message from returned html
                            var $response = $(data.responseText);
                            message = ['<strong>', $response.filter('h1').html(), '</strong>: ',
                                        $response.filter('p').html()].join('');
                        } else {
                            message = 'Unknown Server Error.';
                        }
                        $mainModal.modal('hide');
                        // add alert message to top of page
                        $('.alert-box').html(createAlert(message, 'danger'));
                        $('body').scrollTop(0); // scroll to top of window
                    }

                 }
            });
        });


        function init() {
            if (tutorials.length > 0) {
                tutorialAddRows(tutorials);
            } else {
                addEmptyRow('#tutorial-table', 'No published tutorials', 4)
            }
            updateProfile(userInfo);
        }

        init();
    }(jQuery)
</script>
{% endblock %}